name: ğŸ® Build OTX Server 2 - Tibia Emulator  
on:   
  push:  
    branches: [ main, develop ]  
  pull_request:  
    branches: [ main ]  
  
env:  
  BOOST_VERSION: "1.84.0"  
  MSVC_VERSION: "14.3"  
  BUILD_START_TIME: ${{ github.event.head_commit.timestamp }}  
  
jobs:  
  build:  
    name: ğŸ”¨ Build & Package OTX Server  
    runs-on: windows-latest  
    strategy:  
      matrix:  
        include:  
          - configuration: Release  
            platform: x64  
            emoji: "ğŸš€"  
            color: "green"  
          - configuration: Debug  
            platform: x64  
            emoji: "ğŸ›"  
            color: "yellow"  
      
    steps:  
      - name: ğŸ“¥ Checkout Repository  
        uses: actions/checkout@v4  
          
      - name: ğŸ•’ Set Build Start Time  
        run: |  
          Write-Host "â° Build iniciado em: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"  
          echo "BUILD_START_TIME=$(Get-Date)" >> $env:GITHUB_ENV  
        shell: powershell  
          
      - name: ğŸ’¾ Cache Boost Libraries  
        uses: actions/cache@v4  
        id: cache-boost  
        with:  
          path: |  
            C:\ProgramData\chocolatey\lib\boost-msvc-14.3  
            C:\local\boost_1_84_0  
          key: boost-${{ env.BOOST_VERSION }}-msvc-${{ env.MSVC_VERSION }}-choco-${{ runner.os }}  
          restore-keys: |  
            boost-${{ env.BOOST_VERSION }}-msvc-${{ env.MSVC_VERSION }}-choco-  
            boost-${{ env.BOOST_VERSION }}-msvc-  
              
      - name: ğŸ« Install Boost via Chocolatey  
        if: steps.cache-boost.outputs.cache-hit != 'true'  
        run: |  
          Write-Host "ğŸ¯ === INSTALANDO BOOST C++ LIBRARIES ===" -ForegroundColor Cyan  
          Write-Host "ğŸ”½ Baixando Boost ${{ env.BOOST_VERSION }} via Chocolatey..." -ForegroundColor Yellow  
            
          try {  
            choco install boost-msvc-14.3 --version=${{ env.BOOST_VERSION }} -y --no-progress  
            Write-Host "âœ… Boost instalado com sucesso!" -ForegroundColor Green  
          } catch {  
            Write-Host "âŒ Erro na instalaÃ§Ã£o do Boost: $_" -ForegroundColor Red  
            throw  
          }  
            
          Write-Host "ğŸ“ Configurando estrutura de diretÃ³rios..." -ForegroundColor Cyan  
          if (!(Test-Path "C:\local")) {   
            New-Item -ItemType Directory -Path "C:\local"   
            Write-Host "ğŸ“‚ DiretÃ³rio C:\local criado" -ForegroundColor Green  
          }  
            
          if (!(Test-Path "C:\local\boost_1_84_0")) {  
            New-Item -ItemType SymbolicLink -Path "C:\local\boost_1_84_0" -Target "C:\ProgramData\chocolatey\lib\boost-msvc-14.3\tools"  
            Write-Host "ğŸ”— Link simbÃ³lico criado para Boost" -ForegroundColor Green  
          }  
            
          Write-Host "ğŸ‰ Boost configurado e pronto para uso!" -ForegroundColor Green  
        shell: powershell  
          
      - name: ğŸ” Verify Build Environment  
        run: |  
          Write-Host "ğŸ”§ === VERIFICAÃ‡ÃƒO DO AMBIENTE DE BUILD ===" -ForegroundColor Cyan  
          Write-Host ""  
            
          # Verificar Boost  
          $boostStatus = if (Test-Path 'C:\local\boost_1_84_0') { "âœ… ENCONTRADO" } else { "âŒ AUSENTE" }  
          Write-Host "ğŸ“¦ Boost Path: $boostStatus" -ForegroundColor $(if ($boostStatus -like "*ENCONTRADO*") { "Green" } else { "Red" })  
            
          $libsStatus = if (Test-Path 'C:\local\boost_1_84_0\lib64-msvc-14.3') { "âœ… ENCONTRADO" } else { "âŒ AUSENTE" }  
          Write-Host "ğŸ“š Boost Libs: $libsStatus" -ForegroundColor $(if ($libsStatus -like "*ENCONTRADO*") { "Green" } else { "Red" })  
            
          # InformaÃ§Ãµes do sistema  
          Write-Host "ğŸ–¥ï¸ Sistema: Windows ${{ runner.os }}" -ForegroundColor Cyan  
          Write-Host "ğŸ—ï¸ ConfiguraÃ§Ã£o: ${{ matrix.configuration }}" -ForegroundColor Cyan  
          Write-Host "ğŸ¯ Plataforma: ${{ matrix.platform }}" -ForegroundColor Cyan  
            
          Write-Host "ğŸ› ï¸ MSBuild Version:" -ForegroundColor Cyan  
          msbuild -version  
            
          Write-Host ""  
          Write-Host "âœ¨ Ambiente verificado e pronto para build!" -ForegroundColor Green  
        shell: powershell  
          
      - name: âš™ï¸ Setup MSBuild  
        uses: microsoft/setup-msbuild@v2  
          
      - name: ${{ matrix.emoji }} Build OTX Server (${{ matrix.configuration }})  
        run: |  
          Write-Host "ğŸš€ === INICIANDO COMPILAÃ‡ÃƒO DO OTX SERVER 2 ===" -ForegroundColor Cyan  
          Write-Host "ğŸ“‹ ConfiguraÃ§Ã£o: ${{ matrix.configuration }}" -ForegroundColor Yellow  
          Write-Host "ğŸ¯ Plataforma: ${{ matrix.platform }}" -ForegroundColor Yellow  
          Write-Host "ğŸ”¨ Compilador: MSVC ${{ env.MSVC_VERSION }}" -ForegroundColor Yellow  
          Write-Host ""  
            
          $startTime = Get-Date  
          Write-Host "â° InÃ­cio da compilaÃ§Ã£o: $($startTime.ToString('HH:mm:ss'))" -ForegroundColor Cyan  
            
          try {  
            msbuild sources/msvc/TheOTXServer.vcxproj `  
              /p:Configuration=${{ matrix.configuration }} `  
              /p:Platform=${{ matrix.platform }} `  
              /m `  
              /v:minimal `  
              /p:WarningLevel=1 `  
              /p:TreatWarningsAsErrors=false  
                
            $endTime = Get-Date  
            $duration = $endTime - $startTime  
              
            Write-Host ""  
            Write-Host "ğŸ‰ === COMPILAÃ‡ÃƒO CONCLUÃDA COM SUCESSO! ===" -ForegroundColor Green  
            Write-Host "â±ï¸ Tempo de compilaÃ§Ã£o: $($duration.ToString('mm\:ss'))" -ForegroundColor Green  
            Write-Host "âœ… OTX Server 2 compilado com sucesso!" -ForegroundColor Green  
          } catch {  
            Write-Host "âŒ Erro na compilaÃ§Ã£o: $_" -ForegroundColor Red  
            throw  
          }  
        shell: powershell  
          
      - name: ğŸ§ª Run Build Tests & Validation  
        run: |  
          Write-Host "ğŸ” === VALIDAÃ‡ÃƒO DO BUILD ===" -ForegroundColor Cyan  
            
          $exePath = "sources/msvc/x64/${{ matrix.configuration }}/TheOTXServer.exe"  
            
          if (Test-Path $exePath) {  
            $fileInfo = Get-Item $exePath  
            $sizeInMB = [math]::Round($fileInfo.Length / 1MB, 2)  
              
            Write-Host "âœ… ExecutÃ¡vel encontrado!" -ForegroundColor Green  
            Write-Host "ğŸ“¦ Tamanho: $sizeInMB MB" -ForegroundColor Cyan  
            Write-Host "ğŸ“… Data de criaÃ§Ã£o: $($fileInfo.CreationTime)" -ForegroundColor Cyan  
              
            # Verificar dependÃªncias DLL  
            Write-Host "ğŸ“š Verificando dependÃªncias DLL..." -ForegroundColor Cyan  
            try {  
              $deps = dumpbin /dependents $exePath 2>$null | Select-String "\.dll" | Select-Object -First 10  
              if ($deps) {  
                Write-Host "ğŸ”— Principais dependÃªncias encontradas:" -ForegroundColor Green  
                $deps | ForEach-Object { Write-Host "   - $($_.Line.Trim())" -ForegroundColor Gray }  
              }  
            } catch {  
              Write-Host "âš ï¸ NÃ£o foi possÃ­vel verificar dependÃªncias DLL" -ForegroundColor Yellow  
            }  
              
            Write-Host "âœ… ValidaÃ§Ã£o concluÃ­da com sucesso!" -ForegroundColor Green  
          } else {  
            Write-Host "âŒ ExecutÃ¡vel nÃ£o encontrado em: $exePath" -ForegroundColor Red  
            throw "Build falhou - executÃ¡vel nÃ£o foi gerado"  
          }  
        shell: powershell  
          
      - name: ğŸ“Š Build Metrics & Statistics  
        run: |  
          Write-Host "ğŸ“ˆ === MÃ‰TRICAS DO BUILD ===" -ForegroundColor Cyan  
            
          $buildEndTime = Get-Date  
          $totalDuration = $buildEndTime - [DateTime]$env:BUILD_START_TIME  
            
          Write-Host "â±ï¸ DuraÃ§Ã£o total do build: $($totalDuration.ToString('mm\:ss'))" -ForegroundColor Yellow  
            
          $exePath = "sources/msvc/x64/${{ matrix.configuration }}/TheOTXServer.exe"  
          if (Test-Path $exePath) {  
            $exeSize = [math]::Round((Get-Item $exePath).Length / 1MB, 2)  
            Write-Host "ğŸ“¦ Tamanho do executÃ¡vel: $exeSize MB" -ForegroundColor Yellow  
          }  
            
          Write-Host "ğŸ”§ Compilador: MSVC ${{ env.MSVC_VERSION }}" -ForegroundColor Yellow  
          Write-Host "ğŸ“š Boost Version: ${{ env.BOOST_VERSION }}" -ForegroundColor Yellow  
          Write-Host "ğŸ¯ ConfiguraÃ§Ã£o: ${{ matrix.configuration }}" -ForegroundColor Yellow  
          Write-Host "ğŸ—ï¸ Plataforma: ${{ matrix.platform }}" -ForegroundColor Yellow  
          Write-Host "ğŸ–¥ï¸ Runner OS: ${{ runner.os }}" -ForegroundColor Yellow  
            
          Write-Host ""  
          Write-Host "ğŸ“Š EstatÃ­sticas salvas para relatÃ³rio!" -ForegroundColor Green  
        shell: powershell  
          
      - name: ğŸ“¦ Upload Build Artifacts  
        uses: actions/upload-artifact@v4  
        with:  
          name: ğŸ¯ OTXServer-${{ matrix.configuration }}-${{ matrix.platform }}-${{ github.sha }}  
          path: |  
            sources/msvc/x64/${{ matrix.configuration }}/TheOTXServer.exe  
            sources/msvc/x64/${{ matrix.configuration }}/TheOTXServer.pdb  
          retention-days: 30  
            
      - name: ğŸ“‹ Generate Build Report  
        if: always()  
        run: |  
          Write-Host "ğŸ“ Gerando relatÃ³rio detalhado do build..." -ForegroundColor Cyan  
            
          $status = if (${{ job.status }} -eq "success") { "âœ… SUCESSO" } else { "âŒ FALHA" }  
          $exePath = "sources/msvc/x64/${{ matrix.configuration }}/TheOTXServer.exe"  
          $exeExists = Test-Path $exePath  
          $exeSize = if ($exeExists) { [math]::Round((Get-Item $exePath).Length / 1MB, 2) } else { "N/A" }  
            
          $report = @"  
          # ğŸ® OTX Server 2 - Build Report  
            
          ## ğŸ“Š InformaÃ§Ãµes do Build  
          - **Status**: $status  
          - **ConfiguraÃ§Ã£o**: ${{ matrix.configuration }} ${{ matrix.emoji }}  
          - **Plataforma**: ${{ matrix.platform }}  
          - **Commit**: [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})  
          - **Branch**: ${{ github.ref_name }}  
          - **Trigger**: ${{ github.event_name }}  
            
          ## ğŸ”§ Ambiente de Build  
          - **Boost Version**: ${{ env.BOOST_VERSION }}  
          - **MSVC Version**: ${{ env.MSVC_VERSION }}  
          - **Runner OS**: ${{ runner.os }}  
          - **Cache Hit**: ${{ steps.cache-boost.outputs.cache-hit }}  
            
          ## ğŸ“¦ Artefatos Gerados  
          $(if ($exeExists) {  
            "- âœ… TheOTXServer.exe ($exeSize MB)"  
          } else {  
            "- âŒ TheOTXServer.exe (Falha na compilaÃ§Ã£o)"  
          })  
          $(if (Test-Path "sources/msvc/x64/${{ matrix.configuration }}/TheOTXServer.pdb") {  
            "- âœ… TheOTXServer.pdb (SÃ­mbolos de debug)"  
          } else {  
            "- âŒ TheOTXServer.pdb (NÃ£o gerado)"  
          })  
            
          ## ğŸ”— Links Ãšteis  
          - [ğŸ“Š Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})  
          - [ğŸ“ Repository](${{ github.server_url }}/${{ github.repository }})  
          - [ğŸ“‹ Commit Details](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})  
            
          ---  
          *RelatÃ³rio gerado automaticamente em $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')*  
          "@  
            
          $report | Out-File -FilePath "build-report-${{ matrix.configuration }}.md" -Encoding UTF8  
          Write-Host "ğŸ“„ RelatÃ³rio salvo como build-report-${{ matrix.configuration }}.md" -ForegroundColor Green  
        shell: powershell  
  
      - name: ğŸ“¤ Upload Build Report  
        uses: actions/upload-artifact@v4  
        if: always()  
        with:  
          name: ğŸ“‹ BuildReport-${{ matrix.configuration }}-${{ matrix.platform }}  
          path: build-report-${{ matrix.configuration }}.md  
          retention-days: 90  
            
      - name: ğŸš€ Prepare Release Package  
        if: github.ref == 'refs/heads/main' && matrix.configuration == 'Release'  
        run: |  
          Write-Host "ğŸ“¦ === CRIANDO PACOTE DE RELEASE ===" -ForegroundColor Cyan  
            
          New-Item -ItemType Directory -Path "release-package" -Force  
            
          # Copiar executÃ¡vel principal  
          Copy-Item "sources/msvc/x64/Release/TheOTXServer.exe" "release-package/"  
          Write-Host "âœ… ExecutÃ¡vel copiado" -ForegroundColor Green  
            
          # Copiar arquivos de configuraÃ§Ã£o se existirem  
          $configFiles = @("config.lua
