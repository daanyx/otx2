name: üèóÔ∏è Build OTX Server - Release x64  
on:     
  push:    
    branches: [ main, develop ]    
  pull_request:    
    branches: [ main ]    
    
jobs:    
  build:    
    name: üöÄ Build Release x64  
    runs-on: windows-latest  
        
    steps:    
      - name: üì• Checkout Repository  
        uses: actions/checkout@v4    
            
      - name: üíæ Cache Boost Libraries  
        uses: actions/cache@v4    
        id: cache-boost    
        with:    
          path: |    
            C:\ProgramData\chocolatey\lib\boost-msvc-14.3*  
            C:\local\boost_1_84_0    
          key: boost-1.84.0-msvc-14.3-choco-${{ runner.os }}    
              
      - name: üç´ Install Boost via Chocolatey    
  if: steps.cache-boost.outputs.cache-hit != 'true'    
  run: |    
    Write-Host "Instalando Boost 1.84.0..." -ForegroundColor Yellow  
    choco install boost-msvc-14.3 --version=1.84.0 -y    
      
    Write-Host "Verificando instalacao do Boost..." -ForegroundColor Cyan  
      
    # Verificar onde o Boost foi instalado - pegar apenas o primeiro resultado  
    $boostLibPath = Get-ChildItem "C:\ProgramData\chocolatey\lib" -Directory | Where-Object { $_.Name -like "*boost*" } | Select-Object -First 1  
      
    if ($boostLibPath) {  
      Write-Host "Boost encontrado em: $($boostLibPath.FullName)" -ForegroundColor Green  
        
      # Lista de poss√≠veis caminhos onde o Boost pode estar  
      $possiblePaths = @(  
        (Join-Path $boostLibPath.FullName "tools"),  
        $boostLibPath.FullName  
      )  
        
      $foundPath = $null  
      foreach ($path in $possiblePaths) {  
        if (Test-Path $path) {  
          $foundPath = $path  
          Write-Host "Boost encontrado em: $path" -ForegroundColor Green  
          break  
        }  
      }  
        
      Write-Host "Configurando diretorios..." -ForegroundColor Cyan  
      if (!(Test-Path "C:\local")) {   
        New-Item -ItemType Directory -Path "C:\local"   
      }  
        
      if ($foundPath -and !(Test-Path "C:\local\boost_1_84_0")) {  
        New-Item -ItemType SymbolicLink -Path "C:\local\boost_1_84_0" -Target $foundPath  
        Write-Host "Link simbolico criado: C:\local\boost_1_84_0 -> $foundPath" -ForegroundColor Green  
      }  
    } else {  
      throw "Boost nao encontrado apos instalacao"  
    }  
      
    Write-Host "Boost configurado com sucesso!" -ForegroundColor Green  
  shell: powershell
            
      - name: ‚öôÔ∏è Setup MSBuild    
        uses: microsoft/setup-msbuild@v2    
            
      - name: üîç Verify Build Environment    
        run: |    
          Write-Host "=== Build Environment Check ===" -ForegroundColor Cyan  
          Write-Host "Boost Path: $(if (Test-Path 'C:\local\boost_1_84_0') { 'OK' } else { 'MISSING' })"    
          Write-Host "Boost Libs: $(if (Test-Path 'C:\local\boost_1_84_0\lib64-msvc-14.3') { 'OK' } else { 'MISSING' })"    
          Write-Host "MSBuild Version:" -ForegroundColor Cyan  
          msbuild -version    
          Write-Host "Environment ready!" -ForegroundColor Green  
        shell: powershell    
            
      - name: üöÄ Build OTX Server (Release x64)  
        run: |    
          Write-Host "Compilando OTX Server em Release x64..." -ForegroundColor Yellow  
          msbuild sources/msvc/TheOTXServer.vcxproj /p:Configuration=Release /p:Platform=x64 /m /v:minimal /p:WarningLevel=1  
          Write-Host "Compilacao concluida!" -ForegroundColor Green  
        shell: powershell    
            
      - name: üß™ Validate Build Output  
        run: |  
          Write-Host "=== VALIDACAO DO BUILD ===" -ForegroundColor Cyan  
            
          $exePath = "sources/msvc/x64/Release/TheOTXServer.exe"  
            
          if (Test-Path $exePath) {  
            $fileInfo = Get-Item $exePath  
            $sizeInMB = [math]::Round($fileInfo.Length / 1MB, 2)  
              
            Write-Host "Executavel encontrado!" -ForegroundColor Green  
            Write-Host "Tamanho: $sizeInMB MB" -ForegroundColor Cyan  
            Write-Host "Data de criacao: $($fileInfo.CreationTime)" -ForegroundColor Cyan  
            Write-Host "Build validado com sucesso!" -ForegroundColor Green  
          } else {  
            Write-Host "Executavel nao encontrado em: $exePath" -ForegroundColor Red  
            throw "Build falhou - executavel nao foi gerado"  
          }  
        shell: powershell  
            
      - name: üì¶ Upload Release Artifacts  
        uses: actions/upload-artifact@v4    
        with:    
          name: üéØ OTXServer-Release-x64-${{ github.sha }}  
          path: |    
            sources/msvc/x64/Release/TheOTXServer.exe    
            sources/msvc/x64/Release/TheOTXServer.pdb    
          retention-days: 30  
  
      - name: üìä Build Summary  
        if: success()  
        run: |  
          Write-Host "=== BUILD SUCCESSFUL ===" -ForegroundColor Green  
          Write-Host "Artifact: OTXServer-Release-x64-${{ github.sha }}" -ForegroundColor Cyan  
          $exeSize = [math]::Round((Get-Item 'sources/msvc/x64/Release/TheOTXServer.exe').Length / 1MB, 2)  
          Write-Host "Size: $exeSize MB" -ForegroundColor Cyan  
          Write-Host "Build completed at: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Cyan  
          Write-Host "Ready for deployment!" -ForegroundColor Green  
        shell: powershell
